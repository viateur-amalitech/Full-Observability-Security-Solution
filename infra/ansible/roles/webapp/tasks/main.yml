---
- name: Pull the latest Docker image
  docker_image:
    name: "{{ docker_image }}"
    source: pull

- name: Pull Prometheus image
  docker_image:
    name: prom/prometheus:latest
    source: pull

- name: Pull Grafana image
  docker_image:
    name: grafana/grafana:latest
    source: pull

- name: Create Prometheus config directory
  file:
    path: /home/ec2-user/prometheus
    state: directory
    owner: ec2-user
    mode: '0755'

- name: Copy Prometheus config
  copy:
    dest: /home/ec2-user/prometheus/prometheus.yml
    content: |
      global:
        scrape_interval: 15s

      scrape_configs:
        - job_name: 'webapp'
          static_configs:
            - targets: ['web-app:80']
          metrics_path: '/metrics'

- name: Create Docker network for observability
  docker_network:
    name: observability
    state: present

- name: Run the web application container
  docker_container:
    name: web-app
    image: "{{ docker_image }}"
    state: started
    restart_policy: unless-stopped
    ports:
      - "80:3000"
    networks:
      - name: observability
    env:
      APP_MESSAGE: "{{ app_message }}"
      APP_VERSION: "{{ app_version }}"
    log_driver: awslogs
    log_options:
      awslogs-region: "{{ aws_region | default('eu-north-1') }}"
      awslogs-group: "/docker/web-app"
      awslogs-stream: "web-app"

- name: Run Prometheus container
  docker_container:
    name: prometheus
    image: prom/prometheus:latest
    state: started
    restart_policy: unless-stopped
    ports:
      - "9090:9090"
    networks:
      - name: observability
    volumes:
      - /home/ec2-user/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml

- name: Run Grafana container
  docker_container:
    name: grafana
    image: grafana/grafana:latest
    state: started
    restart_policy: unless-stopped
    ports:
      - "3000:3000"
    networks:
      - name: observability
    env:
      GF_SECURITY_ADMIN_PASSWORD: "admin"

- name: Remove unused images
  docker_prune:
    images: yes
    images_filters:
      dangling: false